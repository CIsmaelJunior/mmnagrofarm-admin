---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Récupérer les données du panier côté serveur (optionnel)
---

<Layout title="Mon Panier - MMB AgroFarm" description="Gérez votre panier et demandez un devis pour vos produits sélectionnés.">
  <Header />
  
  <!-- Hero Section -->
  <section class="pt-32 pb-16 bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-6">
          Mon <span class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-600">Panier</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Révisez vos sélections et demandez un devis personnalisé pour vos produits.
        </p>
      </div>
    </div>
  </section>

  <!-- Contenu du Panier -->
  <section class="py-16">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Liste des produits -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Produits sélectionnés</h2>
            
            <!-- Panier vide -->
            <div id="empty-cart" class="text-center py-12 hidden">
              <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-shopping-cart text-4xl text-gray-400"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Votre panier est vide</h3>
              <p class="text-gray-600 mb-6">Commencez par ajouter des produits à votre panier.</p>
              <a href="/produits" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-green-600 border-2 border-green-600 rounded-lg hover:bg-green-600 hover:text-white transition-all duration-200">
                Voir nos produits
              </a>
            </div>
            
            <!-- Liste des produits -->
            <div id="cart-items" class="space-y-4">
              <!-- Les produits seront ajoutés ici dynamiquement -->
            </div>
          </div>
        </div>
        
        <!-- Formulaire de devis -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 sticky top-32">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Demande de devis</h2>
            
            <form id="devis-form" class="space-y-6">
              <!-- Informations personnelles -->
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Vos informations</h3>
                <div class="space-y-4">
                  <div>
                    <label for="nom" class="block text-sm font-medium text-gray-700 mb-1">Nom complet *</label>
                    <input type="text" id="nom" name="nom" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                  
                  <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                  
                  <div>
                    <label for="telephone" class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                    <input type="tel" id="telephone" name="telephone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                  
                  <div>
                    <label for="entreprise" class="block text-sm font-medium text-gray-700 mb-1">Entreprise</label>
                    <input type="text" id="entreprise" name="entreprise" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                </div>
              </div>
              
              <!-- Informations de livraison -->
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Livraison</h3>
                <div class="space-y-4">
                  <div>
                    <label for="adresse" class="block text-sm font-medium text-gray-700 mb-1">Adresse de livraison *</label>
                    <textarea id="adresse" name="adresse" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"></textarea>
                  </div>
                  
                  <div>
                    <label for="ville" class="block text-sm font-medium text-gray-700 mb-1">Ville *</label>
                    <input type="text" id="ville" name="ville" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                  
                  <div>
                    <label for="code_postal" class="block text-sm font-medium text-gray-700 mb-1">Code postal</label>
                    <input type="text" id="code_postal" name="code_postal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                </div>
              </div>
              
              <!-- Informations supplémentaires -->
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Informations supplémentaires</h3>
                <div class="space-y-4">
                  <div>
                    <label for="date_livraison" class="block text-sm font-medium text-gray-700 mb-1">Date de livraison souhaitée</label>
                    <input type="date" id="date_livraison" name="date_livraison" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                  </div>
                  
                  <div>
                    <label for="commentaires" class="block text-sm font-medium text-gray-700 mb-1">Commentaires ou exigences particulières</label>
                    <textarea id="commentaires" name="commentaires" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"></textarea>
                  </div>
                </div>
              </div>
              
              <!-- Résumé du panier -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3">Résumé de votre commande</h4>
                <div id="cart-summary" class="space-y-2 text-sm text-gray-600">
                  <!-- Le résumé sera ajouté ici dynamiquement -->
                </div>
                <div class="border-t border-gray-200 mt-3 pt-3">
                  <div class="flex justify-between items-center font-semibold text-gray-900">
                    <span>Total des articles</span>
                    <span id="total-items">0</span>
                  </div>
                </div>
              </div>
              
              <!-- Bouton de soumission -->
              <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                <div class="flex items-center justify-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Demander un devis
                </div>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <Footer />
</Layout>

<script>
  // Variables globales
  let cart: any[] = [];
  
  // Initialisation au chargement de la page
  document.addEventListener('DOMContentLoaded', function() {
    loadCart();
    setupFormValidation();
  });
  
  // Charger le panier depuis le localStorage
  function loadCart() {
    const cartData = localStorage.getItem('mmb-cart');
    cart = cartData ? JSON.parse(cartData) : [];
    displayCart();
    updateCartSummary();
  }
  
  // Afficher le contenu du panier
  function displayCart() {
    const cartItems = document.getElementById('cart-items');
    const emptyCart = document.getElementById('empty-cart');
    
    if (!cartItems || !emptyCart) return;
    
    if (cart.length === 0) {
      cartItems.classList.add('hidden');
      emptyCart.classList.remove('hidden');
      return;
    }
    
    emptyCart.classList.add('hidden');
    cartItems.classList.remove('hidden');
    
    cartItems.innerHTML = cart.map(item => `
      <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg hover:shadow-md transition-all duration-200">
        <div class="flex-shrink-0">
          <img src="${item.image}" alt="${item.nom}" class="w-16 h-16 object-contain rounded-lg bg-white border border-gray-200">
        </div>
        
        <div class="flex-1 min-w-0">
          <h3 class="text-lg font-semibold text-gray-900">${item.nom}</h3>
          <p class="text-sm text-green-600 font-medium">${item.variete}</p>
          <p class="text-sm text-gray-600">Conditionnement: ${item.conditionnement}</p>
        </div>
        
        <div class="flex items-center space-x-3">
          <div class="flex items-center border border-gray-300 rounded-lg">
            <button 
              type="button" 
              class="px-3 py-1 text-gray-600 hover:text-gray-800 hover:bg-gray-100 transition-colors duration-200"
              onclick="updateQuantity('${item.id}', -1)"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
              </svg>
            </button>
            <span class="px-3 py-1 text-gray-900 font-medium">${item.quantite}</span>
            <button 
              type="button" 
              class="px-3 py-1 text-gray-600 hover:text-gray-800 hover:bg-gray-100 transition-colors duration-200"
              onclick="updateQuantity('${item.id}', 1)"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </button>
          </div>
          
          <button 
            type="button" 
            class="text-red-500 hover:text-red-700 transition-colors duration-200"
            onclick="removeItem('${item.id}')"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    `).join('');
  }
  
  // Mettre à jour la quantité d'un produit
  function updateQuantity(itemId: string, change: number) {
    const item = cart.find((item: any) => item.id === itemId);
    if (!item) return;
    
    const newQuantity = item.quantite + change;
    if (newQuantity < 1) {
      removeItem(itemId);
      return;
    }
    
    item.quantite = newQuantity;
    saveCart();
    displayCart();
    updateCartSummary();
  }
  
  // Supprimer un produit du panier
  function removeItem(itemId: string) {
    cart = cart.filter((item: any) => item.id !== itemId);
    saveCart();
    displayCart();
    updateCartSummary();
  }
  
  // Rendre les fonctions globales
  (window as any).updateQuantity = updateQuantity;
  (window as any).removeItem = removeItem;
  
  // Sauvegarder le panier
  function saveCart() {
    localStorage.setItem('mmb-cart', JSON.stringify(cart));
  }
  
  // Mettre à jour le résumé du panier
  function updateCartSummary() {
    const cartSummary = document.getElementById('cart-summary');
    const totalItems = document.getElementById('total-items');
    
    if (!cartSummary || !totalItems) return;
    
    const total = cart.reduce((sum, item) => sum + item.quantite, 0);
    totalItems.textContent = total;
    
    cartSummary.innerHTML = cart.map(item => `
      <div class="flex justify-between text-sm">
        <span>${item.nom} (${item.conditionnement})</span>
        <span class="font-medium">x${item.quantite}</span>
      </div>
    `).join('');
  }
  
  // Configuration de la validation du formulaire
  function setupFormValidation() {
    const form = document.getElementById('devis-form') as HTMLFormElement;
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (cart.length === 0) {
        alert('Votre panier est vide. Veuillez ajouter des produits avant de demander un devis.');
        return;
      }
      
      // Récupérer les données du formulaire
      const formData = new FormData(form);
      const devisData = {
        produits: cart,
        client: {
          nom: formData.get('nom'),
          email: formData.get('email'),
          telephone: formData.get('telephone'),
          entreprise: formData.get('entreprise'),
          adresse: formData.get('adresse'),
          ville: formData.get('ville'),
          code_postal: formData.get('code_postal'),
          date_livraison: formData.get('date_livraison'),
          commentaires: formData.get('commentaires')
        },
        date_demande: new Date().toISOString()
      };
      
      // Ici, vous pouvez envoyer les données à votre backend
      console.log('Données du devis:', devisData);
      
      // Afficher une confirmation
      showDevisConfirmation();
      
      // Vider le panier
      cart = [];
      saveCart();
      displayCart();
      updateCartSummary();
      
      // Réinitialiser le formulaire
      form.reset();
    });
  }
  
  // Afficher la confirmation de demande de devis
  function showDevisConfirmation() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-32 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-2xl z-50 transform translate-x-full transition-transform duration-300';
    notification.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>Demande de devis envoyée avec succès !</span>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animer l'entrée
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);
    
    // Supprimer après 5 secondes
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 5000);
  }
</script>
